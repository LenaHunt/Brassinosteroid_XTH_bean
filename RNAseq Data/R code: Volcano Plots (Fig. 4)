# Libraries
library(DESeq2)
library(ggplot2)
library(ggrepel)

# Remove treatment "C" (which has missing values for time_point "B")
metadata_filtered <- metadata[metadata$treatment != "C", ]

# Ensure column names of gene_counts match metadata row names (and maintain order)
gene_counts_filtered <- gene_counts[, rownames(metadata_filtered)]

# Ensure treatment and time_point are factors
metadata_filtered$treatment <- droplevels(factor(metadata_filtered$treatment))
metadata_filtered$time_point <- droplevels(factor(metadata_filtered$time_point))

# Create DESeq2 dataset
dds <- DESeqDataSetFromMatrix(countData = gene_counts_filtered,
                              colData = metadata_filtered,
                              design = ~ treatment * time_point)
dds <- DESeq(dds)  # Run DESeq2

# Function to subset by timepoint and run DESeq2
run_DESeq_for_timepoint <- function(dds, timepoint) {
  dds_subset <- dds[, colData(dds)$time_point == timepoint]  # Corrected subsetting
  dds_subset <- DESeqDataSetFromMatrix(countData = counts(dds_subset), 
                                       colData = colData(dds_subset), 
                                       design = ~ treatment)  # Model only treatment
  dds_subset <- DESeq(dds_subset)  # Run DESeq2
  return(dds_subset)
}

# Run DESeq2 separately for Timepoint A and B
dds_A <- run_DESeq_for_timepoint(dds, "A")
dds_B <- run_DESeq_for_timepoint(dds, "B")

# Function to extract full DESeq2 results for different comparisons
extract_full_results <- function(dds_subset, comparison) {
  treatments <- levels(dds_subset$treatment)
  if (!all(comparison %in% treatments)) {
    warning("Skipping comparison ", paste(comparison, collapse = " vs "), " because one or both treatments are missing.")
    return(NULL)
  }
  res <- results(dds_subset, contrast = c("treatment", comparison[1], comparison[2]), independentFiltering = FALSE)
  return(res)
}

# Define comparisons
comparisons <- list(
  "BL_vs_ET" = c("BL", "ET"),
  "BL_vs_BZ" = c("BL", "BZ"),
  "BZ_vs_ET" = c("BZ", "ET")
)

# Extract full results for each comparison and timepoint
results_list_A <- lapply(comparisons, function(comp) extract_full_results(dds_A, comp))
results_list_B <- lapply(comparisons, function(comp) extract_full_results(dds_B, comp))

# Function to count up- and downregulated genes
count_up_down <- function(res) {
  if (is.null(res)) return(c(up = NA, down = NA))  # Handle NULL results
  up <- sum(res$log2FoldChange > 1 & res$padj < 0.05, na.rm = TRUE)
  down <- sum(res$log2FoldChange < -1 & res$padj < 0.05, na.rm = TRUE)
  return(c(up = up, down = down))
}

# Count genes at each timepoint for each comparison
counts_A <- lapply(results_list_A, count_up_down)
counts_B <- lapply(results_list_B, count_up_down)


# Print results
cat("Timepoint A:\n")
for (comp in names(counts_A)) {
  up <- ifelse(is.na(counts_A[[comp]]["up"]), 0, counts_A[[comp]]["up"])
  down <- ifelse(is.na(counts_A[[comp]]["down"]), 0, counts_A[[comp]]["down"])
  cat(comp, ": Upregulated =", up, ", Downregulated =", down, "\n")
}

cat("\nTimepoint B:\n")
for (comp in names(counts_B)) {
  up <- ifelse(is.na(counts_B[[comp]]["up"]), 0, counts_B[[comp]]["up"])
  down <- ifelse(is.na(counts_B[[comp]]["down"]), 0, counts_B[[comp]]["down"])
  cat(comp, ": Upregulated =", up, ", Downregulated =", down, "\n")
}


# Save full results
for (comp in names(results_list_A)) {
  if (!is.null(results_list_A[[comp]])) {
    write.csv(as.data.frame(results_list_A[[comp]]), paste0("DEG_results_", comp, "_TimepointA.csv"))
  }
}
for (comp in names(results_list_B)) {
  if (!is.null(results_list_B[[comp]])) {
    write.csv(as.data.frame(results_list_B[[comp]]), paste0("DEG_results_", comp, "_TimepointB.csv"))
  }
}

# Define your XTH (or other) genes of interest
highlight_genes <- c(
  "004G168700", "002G311200", "009G233200", "003G137600", "003G147500",
  "003G147600", "003G147400", "003G143332", "003G147700", "003G147300",
  "002G244000", "001G265300", "006G033800", "008G129100", "008G129900",
  "007G148500", "001G179900", "005G130900", "011G085200", "003G052400",
  "002G136200", "002G182000", "003G014400", "005G111300", "011G107000",
  "003G231900", "002G008400", "001G098200", "001G098300", "004G062400",
  "004G111800", "007G052800", "007G048300"
)






# Enhanced Volcano Plot Function (merged from both scripts)
plot_volcano <- function(res, timepoint, comparison,
                         up_color = "orchid1", down_color = "orchid4", nonsig_color = "turquoise",
                         genes_to_annotate = NULL) {
  
  res_df <- as.data.frame(res)
  res_df <- res_df[!is.na(res_df$pvalue), ]
  res_df$logP <- -log10(res_df$pvalue)
  res_df$gene <- rownames(res_df)
  
  # Define significance categories
  res_df$Significance <- "Not Significant"
  res_df$Significance[res_df$log2FoldChange > 1 & res_df$padj < 0.05] <- "Upregulated"
  res_df$Significance[res_df$log2FoldChange < -1 & res_df$padj < 0.05] <- "Downregulated"
  
  # Color mapping
  color_map <- c("Upregulated" = up_color,
                 "Downregulated" = down_color,
                 "Not Significant" = nonsig_color)
  
  # Base volcano plot
  p <- ggplot(res_df, aes(x = log2FoldChange, y = logP, color = Significance)) +
    geom_point(alpha = 0.7) +
    theme_minimal() +
    labs(title = paste("Volcano Plot of", comparison, "- Timepoint", timepoint),
         x = "Log2 Fold Change", y = "-log10 p-value") +
    scale_color_manual(values = color_map) +
    xlim(-10, 10) +
    ylim(0, 25) +
    theme(legend.title = element_blank())
  
  # Highlight and label selected genes (only if provided)
  if (!is.null(genes_to_annotate)) {
    highlight_df <- res_df[
      res_df$gene %in% genes_to_annotate & res_df$Significance != "Not Significant",
    ]
    
    if (nrow(highlight_df) > 0) {
      p <- p +
        geom_point(data = highlight_df, aes(x = log2FoldChange, y = logP),
                   color = "black", size = 3) +
        geom_text_repel(data = highlight_df, aes(label = gene),
                        color = "black", size = 4.5, max.overlaps = Inf,
                        box.padding = 0.8, point.padding = 0.5,
                        force = 2, force_pull = 0.2,
                        min.segment.length = 0)
    }
  }
  
  print(p)
}

# Run the loop as before â€” now with highlighting enabled
for (comp in names(results_list_A)) {
  plot_volcano(results_list_A[[comp]], "A", comp, genes_to_annotate = highlight_genes)
  plot_volcano(results_list_B[[comp]], "B", comp, genes_to_annotate = highlight_genes)
}
